<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de E-mail Multimarcas</title>

  <!-- Mustache.js -->
  <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"></script>
  <!-- Quill (CSS + JS) -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 2rem; }
    label { display: block; margin-bottom: .5rem; }
    input, select { width: 100%; padding: .5rem; margin-bottom: 1rem; }
    #editor { height: 200px; margin-bottom: 1rem; background: #fff; }
    button { padding: .75rem 1.5rem; background: #FF621D; color: #fff; border: none; cursor: pointer; margin-right: .5rem; }
    .previews { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem; }
    .preview-frame { width: 100%; height: 400px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Configura múltiples plantillas</h1>
  <form id="config-form" onsubmit="return false;">
    <label>Seleccionar plantilla / Marca:
      <select id="template_selector">
        <option value="mystique_campaña_eng.html">Mystique</option>
        <option value="Planet_campaña_eng.html">Planet</option>
        <option value="Royalton_campaña_eng.html">Royalton</option>
        <option value="Nexus_campaña_eng.html">Nexus</option>
        <option value="VistaSol_campaña_eng.html">VistaSol</option>
        <option value="latam_campaña_eng.html">LatAm</option>
        <option value="hype_campaña_eng.html">HypeTravel</option>
        <option value="Prime_campaña_eng.html">Prime</option>
        <option value="princess_campaña_eng.html">Princess</option>
        <option value="all">Todas</option>
      </select>
    </label>

    <label>Banner image filename (ej. ES_eng.gif):
      <input type="text" id="banner_image_name" value="ES_eng.gif"/>
    </label>

    <label>Contenido dinámico (negritas, saltos, emojis, enlaces…):
      <div id="editor"></div>
    </label>

    <button type="button" onclick="generatePreview()">Generar Previsualización</button>
    <button type="button" id="download-btn" onclick="downloadHTML()" disabled>Descargar HTML</button>
  </form>

  <h2>Previsualizaciones</h2>
  <div class="previews" id="previews"></div>

  <script>
    // Inicializa editor WYSIWYG
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: [['bold','italic','underline'], ['link'], [{ 'list': 'ordered' }, { 'list': 'bullet' }]] }
    });

    // Configuración específica de cada plantilla, extraída de los HTML originales
    const templateConfig = {
      "mystique_campaña_eng.html": {
        base_url:    "https://mystique.nexustours.com/services",
        utm_source:  "mystique",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "Planet_campaña_eng.html": {
        base_url:    "https://planet.nexustours.com",
        utm_source:  "PH",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "Royalton_campaña_eng.html": {
        base_url:    "https://royalton.nexustours.com/services",
        utm_source:  "royalton",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "Nexus_campaña_eng.html": {
        base_url:    "https://www.nexustours.com/discounts",
        utm_source:  "nexusB2C",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "VistaSol_campaña_eng.html": {
        base_url:    "https://vistasol.nexustours.com",
        utm_source:  "vistasol",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "latam_campaña_eng.html": {
        base_url:    "https://latamtravel.nexustours.com",
        utm_source:  "latam",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "hype_campaña_eng.html": {
        base_url:    "https://www.cancuntransfersandtours.com",
        utm_source:  "HypeTravel",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"  
      },
      "Prime_campaña_eng.html": {
        base_url:    "https://primetravelersclub.nexustours.com",
        utm_source:  "prime",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      },
      "princess_campaña_eng.html": {
        base_url:    "https://princess.nexustours.com",
        utm_source:  "princess",
        utm_medium:  "mail",
        utm_campaign:"campaign_2_julio"
      }
    };

    let lastRenderedMap = {};

    async function generatePreview() {
      const sel = document.getElementById('template_selector').value;
      const toProcess = sel === 'all' ? Object.keys(templateConfig) : [sel];
      const previews = document.getElementById('previews');
      previews.innerHTML = '';

      // Lee contenido formateado
      const rawHtml = quill.root.innerHTML;
      for (const tplFile of toProcess) {
        const cfg = templateConfig[tplFile];
        const data = { ...cfg, banner_image_name: document.getElementById('banner_image_name').value.trim() };

        // Procesa enlaces dentro del editor
        const container = document.createElement('div');
        container.innerHTML = rawHtml;
        container.querySelectorAll('a').forEach(a => {
          let href = a.getAttribute('href') || a.textContent.trim();
          if (!/^https?:\/\//i.test(href)) href = 'https://' + href;
          href = href.toLowerCase();
          const sep = href.includes('?') ? '&' : '?';
          href = href + sep +
            'utm_source='   + encodeURIComponent(data.utm_source) +
            '&utm_medium='  + encodeURIComponent(data.utm_medium) +
            '&utm_campaign='+ encodeURIComponent(data.utm_campaign) +
            '&contact_id={{contact.id}}';
          a.setAttribute('href', href);
        });
        data.body_content = container.innerHTML;

        // Renderiza plantilla
        const tplText  = await fetch(tplFile).then(r => r.text());
        const rendered = Mustache.render(tplText, data);
        lastRenderedMap[tplFile] = rendered;

        // Añade iframe de preview
        const frame = document.createElement('iframe');
        frame.className = 'preview-frame';
        frame.srcdoc   = rendered;
        previews.appendChild(frame);
      }

      document.getElementById('download-btn').disabled = false;
    }

    function downloadHTML() {
      const sel = document.getElementById('template_selector').value;
      if (sel === 'all') {
        Object.entries(lastRenderedMap).forEach(([file, html]) => {
          const blob = new Blob([html], { type: 'text/html' });
          const url  = URL.createObjectURL(blob);
          const a    = document.createElement('a');
          a.href     = url;
          a.download = file.replace('.html', '-custom.html');
          a.click();
          URL.revokeObjectURL(url);
        });
      } else {
        const html = lastRenderedMap[sel];
        const blob = new Blob([html], { type: 'text/html' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = sel.replace('.html', '-custom.html');
        a.click();
        URL.revokeObjectURL(url);
      }
    }
  </script>
</body>
</html>
